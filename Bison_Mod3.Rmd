---
title: "Bison"
date: "2023-11-15"
output: html_document
---
### Figuring out a general workflow for this module
1) setwd, all of the same beginning stuff as usual. Don't even put the space for that, they should know to do that by now, but can maybe leave a small reminder.
2) Looking at all of the data: Biomass data and then maybe also a data frame that just has the size information of the different sites (in acres)
3) group in dplyr "group_by" so that they can get data for each site
4) Ask them to find the average biomass at each site (how to get summary statistics of groups)
5) Convert biomass units to match with hectare units: Using mutate to make a new column that is a math function of existing column
6) Ask them to calculate the average biomass/acre at each site
7) Ask them to calculate the estimated total biomass at each site (avg biomass/hectare * total hectares)
8) Ask them to figure out if/which sites can support a viable Bison population (which will be described)
9) Ask them to figure out how many Bison each site can support in total
10) Ask them to think about, discuss, and explain the action that they would recommend to the K'avi community takes for Bison reintroduction: should entire bison population go to just one site, split amongst multiple sites, no sites at all? 
11) Ask them to make plots that can effectively communicate their decision.


```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

#Set your working directory and load in tidyverse
```{r set wd}
current_path = rstudioapi::getActiveDocumentContext()$path #For editing purposes! Students would have to do this step on their own
setwd(dirname(current_path))
```

#Load in tidyverse
```{r tidy}
library(tidyverse)
```

## R Markdown

For many years, the K'Avi tribe has had cattle grazing pastures throughout their land.
Cattle have been a useful agricultural resource, but they are not native to the K'Avi's
region. In the past year, tribal agriculture managers have noticed a decreased vitality 
in many of their grazing lands causing less regrowth and a decrease in native plant species.
This is most likely due to the cattle, as they are non-specific grazers and are a non-native
species. Tribal agriculture managers are considering reintroducing bison to the lands for
both ecological and cultural reasons. Bison are native to this region and have been observed
to increase native grass species richness by 103% in comparison to cattle! Reintroducing bison will 
also re-establish the K'Avi's cultural and historical connections to the land, and can reaffirm food 
sovereignty and provide additional economic benefits. The managers are hoping to repurpose the cattle 
grazing lands to become bison grazing lands to foster a more sustainable agricultural 
practice for the region and to ensure the preservation of the native grasslands.

In collaborations with numerous tribal governments, K'Avi agriculture managers are hoping 
to transfer a herd of 200 bison for reintroduction, which would allow for genetic diversity 
within the herd and opportunities for sustainable hunting. 

To reintroduce bison, the land must have enough available sustenance for the bison to graze
and maintain a healthy lifestyle. The tribal agriculture managers are considering
three sites for reintroduction and have produced a dataset (biomass.csv) with the annual plant biomass 
(i.e., the amount of food available) at each site. They also used GIS to calculate the 
area of each site in hectares (one hectare is roughly equivalent to two football fields), 
producing the dataset "bison_sites.csv". These data will help determine which sites are 
viable for bison reintroduction! While the hope is to eventually reintroduce bison herds to 
all of these sites, K'Avi agricultural managers must currently choose a single site 
to place this first herd of 200 bison. 

##Load in Biomass Data and Site Datasets
```{r}
biomass <- read.csv("Bison_Mod3/biomass.csv", header = TRUE, sep = ',') #this is for our purposes, this would not be written for students in this module
sites <- read.csv("bison_sites.csv", header = TRUE, sep = ',')
#Delete this code at the end!!! Maybe just keep the names "biomass <-" and "sites <-", for consistency sake later on in the module!
```

#Look at all of the data

Previously, we learned to work with data across multiple sites by having each site as a separate column. This approach allowed us to easily graph data from multiple sites over time. Here, since we will not be looking at data over time, we will be comparing data between multiple sites in a different way, with all of the sites in a single column. View the "biomass" dataset to see this structure.

With the data for all of the sites in the same columns, if we took the summary statistics for a column, it would take the summary statistics for all of the sites together, rather than the summary statistics for each site. In order to run code for each site, we can use the "group_by" function, which is part of the tidyverse. The group_by function tells R to group rows of data by their shared values in a given column. A sample of this code can be seen below:
#Group_by in dplyr
```{r group by}
dplyr::group_by(biomass, Site) 
#A breakdown of the components of this code: group_by(name of the dataset, column with values to group by)
#In this code, we are saying to group data in the "biomass" dataset by the values (either 1, 2, or 3) in the "Site" column. This will group all of the data in the Site, Quadrat, and Biomass columns according to the value in the "Site" column. 
```
*They will need to do this again after they convert the units, but this first time is the "we do" portion.* 

**so these are tibbles, but we're not using them like a tibble, which would be like a dataframe but we can rename the columns? so i'm not sure how useful explaining a tibble is here unless we're explicitly telling them how to convert the data into a tibble format we can manipulate? since we're in tidyverse, it basically automatically becomes a tibble instead of a dataframe (this bit would not be included in final version, rather it is an internal note for ourselves**

We can see that this code chunk also just visualized the first section of our data as a table. These tables we produce are called "tibbles" in tidyverse. They are another, simpler way to view the data, and are basically the same as a data frame. 
We won't get too much into all of the specifics of tibbles right now, but here is a bit of helpful information: in the top left corner of each tibble, the dimensions are given to you, and after using the group_by function, it also tells you how many groups there are, and what column they are grouped by. We can make any dataset into a tibble by using "as_tibble()". When you make a dataset into a tibble, you can name the columns with non-standard names (they don't have to have underscores connecting words) which makes for a cleaner presentation than with data frames.

Now, let's look again at the data that we have: we want to figure out which sites have enough food (plant biomass) to support a herd of 200 reintroduced bison. To figure this out, the first step is to calculate the total amount of plant biomass at each site. However, as the "sites" dataset shows us, these sites are far too large to manually count up the plant biomass for the entire site. Fortunately, this is not necessary. Instead, tribal researchers collected annual plant biomass from fifty 0.25 square meter quadrats (small squares within which data is sampled) at each site, which can be used to estimate the total biomass at each site. 

While this collection method is actually feasible, this dataset doesn't quite yet give the information the tribal agriculture managers are looking for, which is the total biomass at each site. 

#A Note About dplyr
The dplyr package, which is part of the tidyverse, provides numerous unique tools to easily create, edit, and manipulate data, which is often necessary when your raw data is not perfectly set up to answer the questions you are asking. Mastering these tools will give you data management skills relevant and desirable in both academic and professional settings. In this module, we will only discuss a few of the potential data management functions available, but you are encouraged to explore all of the tools and make decisions for the appropriate ones to use as you see fit! A "cheat sheet" explaining all of these functions can be found here: 
###dplyr cheat sheet###
https://www.rstudio.com/wp-content/uploads/2015/02/data-wrangling-cheatsheet.pdf

####The big question####
What we have right now is the annual biomass in fifty 0.25 square meter quadrats at each site. How can we turn these fifty values into an estimate of the total biomass at each site?

Using group_by and summary to get the average biomass/quadrat at each site
```{r group and summary}
biomass %>% 
  group_by(Site) %>% 
  summarise(avg_biomass=mean(Biomass))
```
*Side note: Even though this code chunk produced a 3 x 2 tibble showing us average biomass at each site, this did not change the "biomass" dataset, and we can see that this tibble is not in our Global Environment, and does not actually have a name. This is because we did not give this tibble a name and assign it to a new dataset (using the <-).*

What site has the highest average plant biomass in its quadrats? What might this tell us about the viability of these sites for bison reintroduction?

We take the average quadrat biomass at each site because due to the large size of the sites, it would be extremely time consuming and expensive to get an actual total biomass of each site. This average gives us an idea of the average biomass in each of the 50 quadrats where data was taken. This data is currently in g/m^2, but the site area data has been given in different units-- hectares. Bison also consume a lot of plants, with a single bison needing about 21,900 kg (1 kg = 1000g) of biomass a year to live a healthy life. So, we have data in different units from one another. Fortunately, we can easily do math in R to create new variables with updated units. 

What's the problem with having data in two different units? What should we change the units to?


#Converting the units#
All of the unit conversions that need to happen: 
  currently in g/0.25 m2 and want to get to kg/ha 
  Conversion of g/0.25 m2 to kg/ha is to multiply by 40

To do this conversion and add it to our data, we need to make a new column with the converted units. To make a new column in a dataset, we can use the mutate() function in tidyverse. mutate() creates new columns that are functions of existing variables. It can also modify and delete columns, but we won't do either of those today. To make sure that this does not alter the original data, we will make a copy of the biomass dataset with the new column and assign it to a new dataset (using <-) called "biomass2". Since this is just adding a new column to the original data, you can also apply these changes to "biomass" and not make a new dataset by doing "biomass <-" instead. Just make sure to be careful when making changes to any dataset!
```{r}
  biomass2<- mutate(biomass, kg_ha = Biomass * 40) 
#the various parts of the mutate() function: mutate(name of dataset, new column = function of existing column)
biomass2 #this is optional code that you can also add for this chunk to produce a table where we can view the data from automatically. 
```
This new dataset--biomass2-- now has a new column that converts the biomass in g/m^2 into kg/ha. The column "kg_ha" will be the new column we will call when we are looking at the biomass data because its now in the correct units!

We should take the average biomass per quadrat again, but this time with the converted units. *No code will be given*
```{r new average with right units}
biomass_avg<- biomass2 %>% #making new dataset called biomass_avg 
  group_by(Site) %>% #grouping data by site
  summarise(avg_biomass=mean(kg_ha))
biomass_avg
```

We have just used two different ways of manipulating and creating data in R: the summarise() and mutate() functions. 
They are very similar to each other, but have some key differences from one another. One of the main 
differences between them is that summarise() will only produce a single value per group,
while mutate() produces the same number of rows as the input. 

If you'd like, play around with both mutate() and group_by() %>% summarise() later on in this module to get a clearer idea of how they differ from one another



There is another dataset the tribal agriculture managers have with the sizes of each site in hectares, called "sites", which we loaded in with biomass data at the beginning of class. We are going to merge this "sites" dataset with our "biomass_avg" dataset, which has the average biomass at each site (kg per hectare), into one dataset using the function left_join(), which we learned in the Water Module. We can do this because both datasets have matching columns (Site). 

```{r join}
Site_biomass <- left_join(sites, biomass_avg, by = "Site") #left_join(dataset 1, dataset 2, by = "shared column"); Join matching rows from dataset 2 to dataset 1 using their shared column "Site".
Site_biomass
```
How does merging the datasets help us see the data?

What can this new tibble tell us about the quantity of biomass in each site?

Just from viewing this dataset, do you have a hypothesis of which site might be most suitable to reintroduce bison?


To get a rough estimate of the total available biomass in each site we should multiply the average biomass per quadrat (kg/ha) by the hectares of each site (ha). This will give us a total kg of biomass at each site. This should be added as a new column to the site_biomass tibble.

```{r}
total_available <- mutate(Site_biomass, total_biomass = Hectares * avg_biomass)
total_available
```
What can these totals tell us about each site? Which site do you think is best suited for bison reintroduction? Why?

**ask them to visualize this**

Bison eat a lot of plants! One bison needs about 21,900 kg of biomass a year to live a healthy life. Since we have the total kg of biomass for each site now, we have an idea of which site might be best to introduce the bison. Bison are social animals and live in herds. It is important to the tribal agriculture managers to ensure that they can sustain a full herd population of at least 200 bison. Using mutate(), how many bison can each of these sites maintain?

```{r maximum bison}
max_bison<-mutate(total_available, max_bison=total_biomass/21900) #code not given beyond ~maybe~ max_bison <-mutate()
max_bison
```
Which site(s) would be able to maintain a healthy bison population (around 200 Bison)? 

If you were to share these results with the local community and to other agriculture managers, 
how might you visualize this data to show which site might be best?
*ask them to visualize this data, could be just as a table, or as a bar graph with a threshold line at 200, they get to choose!*

```{r graph bison }
max_bison %>%
  ggplot()+
  geom_bar(aes(x=Site, y= max_bison), stat='identity', fill='green')+
  geom_hline(aes(yintercept = 200))+
  ylab("Max Viable Bison Population")
```

***Day 2***

From last class, we have multiple sites that have enough biomass to sustain a healthy bison population! This is great, but upon further investigation, tribal agriculture managers realize that while the physical amount of biomass might be enough, they didn't take into consideration the quality of the forage. Since bison are generalist foragers, they'll eat almost anything, but they need to make sure that they consume 73,000 g of nitrogen a year. Luckily, the tribal agriculture managers have another dataset that has the nitrogen content per quadrat at each site. 


import N dataset 
```{r import N dataset}
nitrogen <- read.csv("Nitrogen.csv", header = TRUE, sep = ',')
```

Since the data is given in quadrats again, how would we find the total amount of nitrogen available for the bison?
*All of the code will be done by students, using code from Day 1. This is here as an answer key*
*Workflow: Have them take average, maybe convert units, then multiply average by site size to get total N at each site. Then divide by N req. of a bison (TBD) to get max # of Bison the Nutrients at each site can support.
```{r average N}
avg_nitrogen <- nitrogen %>%
  group_by (Site) %>%
  summarise (n_avg=mean(Nitrogen))
avg_nitrogen
```
```{r convert to kg/ha}
avg_nitrogen <- mutate(avg_nitrogen, n_avg_kg_ha = n_avg * 40)
avg_nitrogen
```


```{r}
avgN_per_site <- left_join(sites, avg_nitrogen, by = "Site")
avgN_per_site
```


```{r}
total_N <-avgN_per_site %>%
  group_by(Site)%>%
  summarise(total_n_available = Hectares* n_avg_kg_ha)
mutate(total_N, new_bison= total_n_available/73)
```
  
#insert code to get to the total N when given (ha) already
  
Does this change your decision for which site would be best for reintroduction?


Even though there might be multiple sites with enough biomass to support a large herd of
bison, it is not plausible that the bison will eat 100% of the forage available. There are
elk populations present in the prairies that must be accounted for to ensure that both
groups have enough biomass to sustain their populations.The present elk population must be
able to coexist with the reintroduced bison population. Elk require 2,158 kg/year of plant
biomass.

1) import elk dataset
```{r import elk data}
elk <- read.csv("elk.csv", header = TRUE, sep = ',')
```

How much biomass are the elk consuming per site?
2) each site has x, y, z of elk
  - multiply number of elk by kg of biomass per elk (2,518 kg/year)
```{r kg biomass for elk}
elk_consumption <- mutate(elk, biomass_consumed = Elk * 2518)
elk_consumption
```
(below is not a prompt for them, but instead to demonstrate if they instead choose to figure this out using group_by() %>% summarise())
```{r}
 elk_consum <- elk %>%
  group_by(Site)%>%
  summarise(elk_consum = Elk * 2518)
elk_consum
```
Are these herds of elk consuming more or less biomass than the bison? 


What does this tell us about the effect they'll have on the site we reintroduce bison to?


How would we go about determining the total biomass available at each site when the elk consumption is
taken into consideration?

3) subtract from total biomass of site
```{r subtracts from total biomass}
elk_site <- left_join(total_available, elk_consumption, by = "Site")
elk_site
```

```{r Biomass available for Bison after Accounting for Elk}
biomass_post_elk <- mutate(elk_site, post_elk_biomass = total_biomass - biomass_consumed)
biomass_post_elk
```


Now that we have the biomass after considering the elk, tribal agriculture managers want a visual
representation of the biomass available per site. This can be a tibble, graph, etc, but they want
something that clearly communicates the biomass per site with units and a title. Make it pretty! The
most effective communication is clear and concise!

4) graph biomass per site
```{r bargraph of new available biomass}
library(ggplot2)
biomass_post_elk %>%
  ggplot()+
  geom_bar(aes(x=Site, y= post_elk_biomass), stat='identity', fill='green')+
  geom_hline(aes(yintercept = 4380000))+ #this is the line representing the biomass level necessary for 200 bison. I did this math separately, which they could also do, but is not expected of them. 
  ylab("Total Biomass (kg)")

```
Why do you believe this is the best way to present the data?


Is there another way to show this data?
#Would be better to actually change the units of the biomass to kg (in millions), since the numbers currently are unreadable since they are so large#

It's great to have an understanding of just how much is available for the bison, with the elk in
consideration. As tribal agriculture managers begin the process of reintroduction, they once again would like to know the maximum number of bison they can introduce to each site. Ideally, they would be able to introduce a herd of <200 bison to ensure a healthy and stable population.

5) divide new biomass by bison to get new population #
```{r max bison with elk}
bison_elk <- biomass_post_elk %>%
  group_by(Site) %>%
  summarise(max_bison = post_elk_biomass / 21900) #could also be done with mutate() as an alternative! This is instructors version, so the route that students take does not matter as much!
bison_elk
```

Graph this data in a fashion that would communicate well to the K'Avi community:
```{r post elk viable bison pop graph}
bison_elk %>%
  ggplot()+
  geom_bar(aes(x=Site, y= max_bison), stat='identity', fill='green')+
  geom_hline(aes(yintercept = 200))+
  ylab("Max Viable Bison Population")
```
Does this change which sites we should introduce the bison to?


Why is important to consider outside factors when working with data?


Are there any other factors you would consider when looking to reintroduce a species into its native
habitat?



